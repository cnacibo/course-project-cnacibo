name: Security - SAST & Secrets

on:
  workflow_dispatch:
  push:
    paths:
      - "**/*.py"
      - "security/semgrep/**"
      - "security/.gitleaks.toml"
      - ".github/workflows/ci-sast-secrets.yml"

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sast_secrets:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure evidence directories
        run: mkdir -p EVIDENCE/P10

      - name: Semgrep SAST Scan
        id: semgrep
        run: |
          echo "Running Semgrep SAST scan..."
          docker run --rm \
            -v "$PWD:/src" \
            -e SEMGREP_APP_TOKEN="" \
            returntocorp/semgrep:latest \
            semgrep ci \
            --config p/ci \
            --config /src/security/semgrep/rules.yml \
            --sarif \
            --output /src/EVIDENCE/P10/semgrep.sarif \
            --metrics=off \
            --no-suppress-errors

          if [ -f "EVIDENCE/P10/semgrep.sarif" ]; then
            echo "Semgrep report generated successfully"
            echo "# Semgrep Scan Summary" > EVIDENCE/P10/semgrep_summary.md
            echo "Generated: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> EVIDENCE/P10/semgrep_summary.md
            echo "" >> EVIDENCE/P10/semgrep_summary.md
            echo "Report file: semgrep.sarif" >> EVIDENCE/P10/semgrep_summary.md
            echo "Scan completed successfully." >> EVIDENCE/P10/semgrep_summary.md
          else
            echo "Warning: Semgrep report file not created"
          fi

      - name: Upload SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        if: success() && github.event_name == 'push'
        with:
          sarif_file: EVIDENCE/P10/semgrep.sarif
          wait-for-processing: true

      - name: Gitleaks detect
        id: gitleaks
        run: |
          docker run --rm \
            -v "$PWD:/repo" \
            zricethezav/gitleaks:latest \
            detect \
            --no-banner \
            --config=/repo/security/.gitleaks.toml \
            --source=/repo \
            --report-format=json \
            --report-path=/repo/EVIDENCE/P10/gitleaks.json \
            --verbose

          if [ -f "EVIDENCE/P10/gitleaks.json" ]; then
            echo "# Gitleaks Scan Summary" > EVIDENCE/P10/gitleaks_summary.md
            echo "Generated: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> EVIDENCE/P10/gitleaks_summary.md
            echo "" >> EVIDENCE/P10/gitleaks_summary.md
            echo "Report file: gitleaks.json" >> EVIDENCE/P10/gitleaks_summary.md

            if jq -e '. | length > 0' EVIDENCE/P10/gitleaks.json > /dev/null 2>&1; then
              echo "Secrets found! Check gitleaks.json for details." >> EVIDENCE/P10/gitleaks_summary.md
              COUNT=$(jq '. | length' EVIDENCE/P10/gitleaks.json)
              echo "Total findings: $COUNT" >> EVIDENCE/P10/gitleaks_summary.md
            else
              echo "No secrets found." >> EVIDENCE/P10/gitleaks_summary.md
            fi
          fi

      - name: Create Combined Summary
        run: |
          echo "# P10 - SAST & Secrets Scan Results" > EVIDENCE/P10/combined_summary.md
          echo "" >> EVIDENCE/P10/combined_summary.md
          echo "## Scan Information" >> EVIDENCE/P10/combined_summary.md
          echo "- Repository: ${{ github.repository }}" >> EVIDENCE/P10/combined_summary.md
          echo "- Branch: ${{ github.ref_name }}" >> EVIDENCE/P10/combined_summary.md
          echo "- Commit: ${{ github.sha }}" >> EVIDENCE/P10/combined_summary.md
          echo "- Run ID: ${{ github.run_id }}" >> EVIDENCE/P10/combined_summary.md
          echo "" >> EVIDENCE/P10/combined_summary.md

          if [ -f "EVIDENCE/P10/semgrep_summary.md" ]; then
            echo "## Semgrep SAST Results" >> EVIDENCE/P10/combined_summary.md
            cat EVIDENCE/P10/semgrep_summary.md | tail -n +2 >> EVIDENCE/P10/combined_summary.md
          fi

          if [ -f "EVIDENCE/P10/gitleaks_summary.md" ]; then
            echo "" >> EVIDENCE/P10/combined_summary.md
            echo "## Gitleaks Secrets Results" >> EVIDENCE/P10/combined_summary.md
            cat EVIDENCE/P10/gitleaks_summary.md | tail -n +2 >> EVIDENCE/P10/combined_summary.md
          fi

          echo "" >> EVIDENCE/P10/combined_summary.md
          echo "## Next Step" >> EVIDENCE/P10/combined_summary.md
          echo "Review findings in the detailed reports" >> EVIDENCE/P10/combined_summary.md

      - name: Upload SAST & Secrets evidence
        uses: actions/upload-artifact@v4
        with:
          name: P10_EVIDENCE
          path: |
            EVIDENCE/P10/
            security/semgrep/rules.yml
            security/.gitleaks.toml
